<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Manage Users | HomePro Connect</title>
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f5f5f5; }
    h1 { margin-bottom: 20px; }
    .user-table { width:100%; border-collapse: collapse; margin-bottom:20px; background:#fff; }
    .user-table th, .user-table td { border:1px solid #ddd; padding:8px; text-align:left; }
    .user-table th { background:#007bff; color:#fff; }
    .btn { padding:4px 8px; margin:2px; cursor:pointer; border:none; border-radius:4px; }
    .btn-update { background:#28a745; color:#fff; }
    .btn-delete { background:#dc3545; color:#fff; }
    .filter-search { margin-bottom:10px; }
    select, input[type="text"] { padding:5px; margin-right:10px; }
  </style>
</head>
<body>
  <h1>Manage Users</h1>

  <div class="filter-search">
    <input type="text" id="searchUser" placeholder="Search by name or email">
    <select id="filterRole">
      <option value="all">All Roles</option>
      <option value="customer">Customer</option>
      <option value="provider">Provider</option>
      <option value="admin">Admin</option>
    </select>
  </div>

  <table class="user-table" id="usersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>2FA Enabled</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Users will be populated here dynamically -->
    </tbody>
  </table>

  <script>
    const usersTableBody = document.querySelector("#usersTable tbody");
    const searchInput = document.getElementById("searchUser");
    const filterRole = document.getElementById("filterRole");
    const token = localStorage.getItem("token");

    async function fetchUsers() {
      try {
        const res = await fetch("/api/admin/users", {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Failed to fetch users");
        const data = await res.json();
        return data.users || [];
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function renderUsers(users) {
      usersTableBody.innerHTML = "";
      users.forEach(u => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>
            <select data-user-id="${u.id}" class="role-select">
              <option value="customer" ${u.role==="customer"?"selected":""}>Customer</option>
              <option value="provider" ${u.role==="provider"?"selected":""}>Provider</option>
              <option value="admin" ${u.role==="admin"?"selected":""}>Admin</option>
            </select>
          </td>
          <td>${u.twoFAEnabled ? "✅" : "❌"}</td>
          <td>
            <button class="btn btn-update" data-id="${u.id}">Update</button>
            <button class="btn btn-delete" data-id="${u.id}">Delete</button>
          </td>
        `;
        usersTableBody.appendChild(row);
      });

      // Attach event listeners
      document.querySelectorAll(".btn-update").forEach(btn => {
        btn.addEventListener("click", updateUserRole);
      });
      document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.addEventListener("click", deleteUser);
      });
    }

    async function updateUserRole(e) {
      const userId = e.target.dataset.id;
      const roleSelect = document.querySelector(`select[data-user-id="${userId}"]`);
      const newRole = roleSelect.value;

      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ role: newRole })
        });
        const data = await res.json();
        if(res.ok) alert(`User role updated to ${newRole}`);
        else alert(data.error || "Failed to update role");
        await loadUsers();
      } catch(err) {
        console.error(err);
        alert("Network error");
      }
    }

    async function deleteUser(e) {
      if(!confirm("Are you sure you want to delete this user?")) return;
      const userId = e.target.dataset.id;

      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if(res.ok) alert("User deleted");
        else alert(data.error || "Failed to delete user");
        await loadUsers();
      } catch(err) {
        console.error(err);
        alert("Network error");
      }
    }

    function applyFilters(users) {
      const search = searchInput.value.toLowerCase();
      const role = filterRole.value;
      return users.filter(u => 
        (u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search)) &&
        (role==="all" || u.role===role)
      );
    }

    async function loadUsers() {
      const users = await fetchUsers();
      const filtered = applyFilters(users);
      renderUsers(filtered);
    }

    searchInput.addEventListener("input", loadUsers);
    filterRole.addEventListener("change", loadUsers);

    window.addEventListener("DOMContentLoaded", loadUsers);
  </script>
</body>
</html>

